---
- list: system_executables_files
  items: [/proc/filesystems, /proc/self/stat, /usr/lib/locale/locale-archive, /
  usr/bin/systemctl]
- list: system_executables_directories
  items: [/run/systemd/system, /etc/systemd/system-preset, /usr/lib/systemd/sys
tem-preset, /run/systemd/system-preset, /usr/local/lib/systemd/system-preset]
- rule: system service discovery
  desc: an attempt to discover all services that are running in system
  condition: >
    spawned_process
    or (open_read and (fd.directory in (system_executables_directories)) or
    (fd.filename in (system_executables_files)))
  enabled: false
  output: >
    A process with process id=%proc.pid is spawned to discover all the system
    system services present in the system.
  priority: ERROR
  tags: [Mitre_discovery_system_service_discovery]
- list: ssh_files
  items: [/etc/ssh/sshd_config, /.ssh/authorized_keys]
- rule: account_manipulation_in_ssh
  desc: an attempt to do account manipulation using ssh
  condition: >
    ((open_read and (fd.name in (ssh_files)))
    or (open_write and (fd.name in (ssh_files))))
  enabled: true
  output: >
    A process with process id=%proc.pid is spawned to do account manipulation
    at ssh_files
  priority: ERROR
  tags: [mitre account_manipulation]
- rule: Read maps file of process
  desc: An attempt to read the maps file of a process was detected
  condition: open_read and (fd.name glob /proc/*/maps)
  enabled: true
  output: Reading maps file of process
  priority: ERROR
  tags: [os_credential_dumping]
- list: network_tools
  items: ["nmap", "ping", "dig", "nslookup", "arp"]
- rule: Suspicious Network Scanning Command
  desc: Detects suspicious network scanning commands
  condition:
    (proc.name=nmap or proc.name=ping or proc.name=dig or
     proc.name=nslookup or proc.name=arp) and
    (
      proc.args contains "-sP" or
      proc.args contains "-c" or
      proc.args contains "+short" or
      proc.args contains "-a"
    )
  enabled: true
  output: Suspicious network scanning command executed
   (user=%user.name command=%proc.cmdline)
  priority: WARNING
- rule: Chown or Chmod Operation
  desc: Detects chown or chmod operations
  condition: (evt.type = execve and
              (proc.name = chown or proc.name = chmod))
  enabled: true
  output: "Chown or chmod operation detected
   (user=%user.name command=%proc.cmdline)"
  priority: WARNING
- list: groups
  items: [/etc/group]
- list: critical_files
  items: [/etc/group, /etc/passwd, /etc/shadow, /etc/sudoers]
- rule: permission and group members discovery
  desc: rule to detect permission of files and group and its group members
  condition: >
    (open_read and (fd.name in (groups))) or
    (evt.type = stat and (fd.filename in (critical_files)))
  enabled: false
  output: suspicious process is spawwned to check file permissions
   and group members.
  priority: ERROR
- list: data_destruction_cmd
  items: ["shred", "dd", "wipe"]
- rule: Detect data destruction activity
  desc: Detects activity related to data destruction,
   such as file shredding or disk wiping.
  condition: >
    (evt.type = execve and proc.name in (data_destruction_cmd)) or
    (evt.type = openat and fd.name endswith ".shred" or
     fd.name endswith ".wipe")
  enabled: true
  output: >
    Data destruction activity detected.
  priority: WARNING
  tags: [filesystem, process]
- rule: Archive and Compression Activity
  desc: Detects archive and compression activity using tar, zip, gzip, and bzip2.
  condition: >
    (proc.name = "zip" and evt.dir = "<") or 
    (proc.name = "tar" and (evt.arg[1] = "-czf" or evt.arg[1] = "-cpf"))
    or (proc.name = "gzip" and evt.dir = "<")
    or (proc.name = "bzip2" and evt.dir = "<")
  enabled: true
  output:
    "Archive and compression activity detected (user=%user.name command=%proc.cmdline file=%evt.arg[2] or %evt.arg[1])"
  priority: WARNING
- list: device_enumeration
  items: ["lsusb", "lspci", "dmesg", "lsblk", "lshw", "hwinfo"]
- rule: Detect peripheral device enumeration commands
  desc: Detects if someone runs commands that enumerate peripheral devices.
  condition: >
    spawned_process and
    (
      proc.name in (device_enumeration) or
      proc.cmdline contains "lsusb" or
      proc.cmdline contains "lspci" or
      proc.cmdline contains "dmesg" or
      proc.cmdline contains "lsblk" or
      proc.cmdline contains "lshw" or
      proc.cmdline contains "hwinfo"
    )
  enbled: true
  output: >
    Peripheral device enumeration command detected.
  priority: WARNING
- rule: Detect service disable using systemctl
  desc: Detects when a user disables a service using the systemctl command.
  condition: >
    proc.name = "systemctl" and
    proc.args contains "disable" and
    proc.args contains ".service" and
    user.name != "root"
  enabled: true
  output: >
    Service disable using systemctl detected.
  priority: WARNING
- rule: Create NodePort Service
  desc: >
    Detect an attempt to start a service with a NodePort service type
  condition: kevt and service and kcreate and ka.req.service.type=NodePort
  enabled: true
  output: NodePort Service Created (user=%ka.user.name service=%ka.target.name ns=%ka.target.namespace ports=%ka.req.service.ports)
  priority: WARNING
  source: k8s_audit
  tags: [k8s]

- rule: Suspicious Time and Date Command Execution
  desc: Detects the execution of commands that may be used to gather time, date, and region information
  condition: evt.type = execve and evt.dir = < and (proc.name = "date" or proc.name = "timedatectl" or proc.name = "locale" or proc.name = "hostnamectl")
  enabled: true
  output: "Suspicious time and date command executed: user=%user.name pid=%proc.pid ppid=%proc.ppid exe=%proc.exepath cmdline=%proc.cmdline"
  priority: WARNING


